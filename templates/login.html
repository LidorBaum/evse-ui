<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0, viewport-fit=cover">
  <title>Login - MG4 Charger</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <script>
    tailwind.config = { darkMode: 'class' }
  </script>
  <script>
    // Apply dark mode immediately to prevent flash - default to dark
    if (localStorage.getItem('darkMode') !== 'false') {
      document.documentElement.classList.add('dark');
    }
  </script>
  <style>
    body { font-family: 'Inter', system-ui, -apple-system, sans-serif; }
    button {
      transition: transform 0.1s ease, opacity 0.1s ease, background-color 0.15s ease;
    }
    button:active:not(:disabled) {
      transform: scale(0.97);
      opacity: 0.9;
    }
    .btn-loading {
      position: relative;
      color: transparent !important;
    }
    .btn-loading::after {
      content: '';
      position: absolute;
      width: 20px;
      height: 20px;
      top: 50%;
      left: 50%;
      margin-left: -10px;
      margin-top: -10px;
      border: 2px solid rgba(255,255,255,0.3);
      border-radius: 50%;
      border-top-color: #fff;
      animation: spin 0.8s linear infinite;
    }
    @keyframes spin {
      to { transform: rotate(360deg); }
    }
  </style>
</head>
<body class="bg-gray-50 dark:bg-gray-900 min-h-screen flex items-center justify-center transition-colors">
  <div class="bg-white dark:bg-gray-800 rounded-2xl shadow-lg p-8 w-full max-w-sm mx-4 transition-colors">
    <div class="text-center mb-8">
      <div class="text-5xl mb-4">ðŸ”Œ</div>
      <h1 class="text-2xl font-bold text-gray-900 dark:text-white">MG4 Charger</h1>
      <p class="text-gray-500 dark:text-gray-400 mt-2">Enter PIN to continue</p>
    </div>
    
    <input 
      type="password" 
      id="pin" 
      maxlength="4" 
      inputmode="numeric" 
      pattern="[0-9]*"
      placeholder="â€¢â€¢â€¢â€¢"
      autofocus
      class="w-full text-center text-3xl tracking-widest py-4 px-6 border-2 border-gray-200 dark:border-gray-600 rounded-xl bg-white dark:bg-gray-700 text-gray-900 dark:text-white focus:border-emerald-500 focus:ring-0 focus:outline-none transition"
    />
    
    <button onclick="login()" id="loginBtn" 
      class="w-full mt-6 py-4 px-6 rounded-xl font-bold text-white bg-emerald-500 hover:bg-emerald-600 transition cursor-pointer disabled:bg-gray-300 dark:disabled:bg-gray-600 disabled:cursor-not-allowed">
      Enter
    </button>
    
    <p class="text-red-500 text-center mt-4 text-sm" id="error" style="display:none;">Invalid PIN. Try again.</p>
  </div>

<script>
// Dark mode init
(function() {
  // Dark mode is already applied in head, this just ensures consistency
  const isDark = localStorage.getItem('darkMode') !== 'false';
  if (isDark) document.documentElement.classList.add('dark');
  else document.documentElement.classList.remove('dark');
})();

const pinInput = document.getElementById('pin');
const errorEl = document.getElementById('error');
const loginBtn = document.getElementById('loginBtn');

// Auto-submit when 4 digits entered
pinInput.addEventListener('input', () => {
  errorEl.style.display = 'none';
  if (pinInput.value.length === 4) {
    login();
  }
});

// Enter key to submit
pinInput.addEventListener('keypress', (e) => {
  if (e.key === 'Enter') login();
});

async function login() {
  const pin = pinInput.value;
  if (!pin) return;
  
  loginBtn.disabled = true;
  loginBtn.classList.add('btn-loading');
  
  try {
    const r = await fetch('/api/login?pin=' + encodeURIComponent(pin), {
      method: 'POST'
    });
    const data = await r.json();
    
    if (data.ok) {
      window.location.href = '/';
    } else {
      errorEl.style.display = 'block';
      pinInput.value = '';
      pinInput.focus();
      loginBtn.classList.remove('btn-loading');
    }
  } catch(e) {
    errorEl.style.display = 'block';
    loginBtn.classList.remove('btn-loading');
  }
  
  loginBtn.disabled = false;
}
</script>

</body>
</html>
