<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0, viewport-fit=cover">
  <title>MG4 Charger Dashboard</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <script>
    tailwind.config = {
      darkMode: 'class',
    }
  </script>
  <script>
    // Apply dark mode immediately to prevent flash - default to dark
    if (localStorage.getItem('darkMode') !== 'false') {
      document.documentElement.classList.add('dark');
    }
  </script>
  <style>
    :root {
      --primary-green: #10B981;
      --primary-red: #EF4444;
    }
    body {
      font-family: 'Inter', system-ui, -apple-system, sans-serif;
    }
    /* Button animations */
    .btn-press {
      transform: scale(0.97);
      opacity: 0.9;
    }
    button, .btn {
      transition: transform 0.1s ease, opacity 0.1s ease, background-color 0.15s ease;
    }
    button:active:not(:disabled), .btn:active:not(:disabled) {
      transform: scale(0.97);
      opacity: 0.9;
    }
    /* Toast notifications */
    .toast-container {
      position: fixed;
      bottom: 20px;
      left: 50%;
      transform: translateX(-50%);
      z-index: 9999;
      display: flex;
      flex-direction: column;
      gap: 8px;
    }
    .toast {
      padding: 12px 20px;
      border-radius: 10px;
      color: white;
      font-weight: 500;
      box-shadow: 0 4px 12px rgba(0,0,0,0.3);
      animation: slideUp 0.3s ease;
      max-width: 90vw;
    }
    .toast-warning {
      background: linear-gradient(135deg, #f59e0b, #d97706);
    }
    .toast-error {
      background: linear-gradient(135deg, #ef4444, #dc2626);
    }
    @keyframes slideUp {
      from { opacity: 0; transform: translateY(20px); }
      to { opacity: 1; transform: translateY(0); }
    }
    @keyframes fadeOut {
      from { opacity: 1; }
      to { opacity: 0; }
    }
    /* Ripple effect */
    .ripple {
      position: relative;
      overflow: hidden;
    }
    .ripple::after {
      content: '';
      position: absolute;
      width: 100%;
      height: 100%;
      top: 0;
      left: 0;
      pointer-events: none;
      background-image: radial-gradient(circle, #fff 10%, transparent 10.01%);
      background-repeat: no-repeat;
      background-position: 50%;
      transform: scale(10, 10);
      opacity: 0;
      transition: transform .4s, opacity .8s;
    }
    .ripple:active::after {
      transform: scale(0, 0);
      opacity: .3;
      transition: 0s;
    }
    /* Loading spinner for buttons */
    .btn-loading {
      position: relative;
      color: transparent !important;
    }
    .btn-loading::after {
      content: '';
      position: absolute;
      width: 20px;
      height: 20px;
      top: 50%;
      left: 50%;
      margin-left: -10px;
      margin-top: -10px;
      border: 2px solid rgba(255,255,255,0.3);
      border-radius: 50%;
      border-top-color: #fff;
      animation: spin 0.8s linear infinite;
    }
    @keyframes spin {
      to { transform: rotate(360deg); }
    }
    /* Charging animation - synced across cards */
    @keyframes pulse-glow {
      0%, 100% { box-shadow: 0 0 0 0 rgba(16, 185, 129, 0.3); }
      50% { box-shadow: 0 0 15px 5px rgba(16, 185, 129, 0.15); }
    }
    /* Left card: flow enters from left, exits to right */
    @keyframes energy-flow-left {
      0% { background-position: 300% 0; }
      100% { background-position: -100% 0; }
    }
    /* Right card: same timing, continues the flow */
    @keyframes energy-flow-right {
      0% { background-position: 200% 0; }
      100% { background-position: -200% 0; }
    }
    .charging-active {
      animation: pulse-glow 3s ease-in-out infinite;
    }
    .charging-bar-left {
      background: linear-gradient(90deg, 
        transparent 0%, 
        rgba(16, 185, 129, 0.15) 20%, 
        rgba(16, 185, 129, 0.35) 50%, 
        rgba(16, 185, 129, 0.15) 80%, 
        transparent 100%);
      background-size: 200% 100%;
      animation: energy-flow-left 4s ease-in-out infinite;
    }
    .charging-bar-right {
      background: linear-gradient(90deg, 
        transparent 0%, 
        rgba(16, 185, 129, 0.15) 20%, 
        rgba(16, 185, 129, 0.35) 50%, 
        rgba(16, 185, 129, 0.15) 80%, 
        transparent 100%);
      background-size: 200% 100%;
      animation: energy-flow-right 4s ease-in-out infinite;
    }
    @keyframes bolt-pulse {
      0%, 100% { opacity: 1; transform: scale(1); }
      50% { opacity: 0.7; transform: scale(1.05); }
    }
    .bolt-animate {
      animation: bolt-pulse 2s ease-in-out infinite;
    }
  </style>
</head>
<body class="bg-gray-50 dark:bg-gray-900 min-h-screen transition-colors duration-200">
  <!-- Error Alert Banner (hidden by default) -->
  <div id="errorAlert" class="hidden fixed top-0 left-0 right-0 z-50 bg-red-500 text-white px-4 py-3 shadow-lg">
    <div class="max-w-5xl mx-auto flex items-center justify-between">
      <div class="flex items-center gap-2">
        <span class="text-xl">‚ö†Ô∏è</span>
        <span id="errorAlertText" class="font-medium">Charger Error Detected</span>
      </div>
      <button onclick="dismissErrorAlert()" class="text-white hover:text-red-100 text-xl">&times;</button>
    </div>
  </div>

  <!-- Toast Container -->
  <div id="toastContainer" class="toast-container"></div>

  <!-- Header -->
  <header class="bg-white dark:bg-gray-800 shadow-sm sticky top-0 z-10 transition-colors pt-[env(safe-area-inset-top)]">
    <div class="max-w-5xl mx-auto px-4 sm:px-6 lg:px-8 flex justify-between items-center h-16">
      <h1 class="text-xl font-semibold text-gray-900 dark:text-white">MG4 Charger</h1>
      <div class="flex items-center space-x-2">
        <button onclick="toggleDarkMode()" id="darkModeBtn" class="text-sm font-medium text-gray-600 dark:text-gray-300 hover:text-gray-900 dark:hover:text-white hover:bg-gray-100 dark:hover:bg-gray-700 px-3 py-2 rounded-lg transition" title="Toggle dark mode">
          <span id="darkModeIcon">
            <svg class="w-5 h-5 hidden dark:block" fill="currentColor" viewBox="0 0 20 20"><path fill-rule="evenodd" d="M10 2a1 1 0 011 1v1a1 1 0 11-2 0V3a1 1 0 011-1zm4 8a4 4 0 11-8 0 4 4 0 018 0zm-.464 4.95l.707.707a1 1 0 001.414-1.414l-.707-.707a1 1 0 00-1.414 1.414zm2.12-10.607a1 1 0 010 1.414l-.706.707a1 1 0 11-1.414-1.414l.707-.707a1 1 0 011.414 0zM17 11a1 1 0 100-2h-1a1 1 0 100 2h1zm-7 4a1 1 0 011 1v1a1 1 0 11-2 0v-1a1 1 0 011-1zM5.05 6.464A1 1 0 106.465 5.05l-.708-.707a1 1 0 00-1.414 1.414l.707.707zm1.414 8.486l-.707.707a1 1 0 01-1.414-1.414l.707-.707a1 1 0 011.414 1.414zM4 11a1 1 0 100-2H3a1 1 0 000 2h1z" clip-rule="evenodd"></path></svg>
            <svg class="w-5 h-5 block dark:hidden" fill="currentColor" viewBox="0 0 20 20"><path d="M17.293 13.293A8 8 0 016.707 2.707a8.001 8.001 0 1010.586 10.586z"></path></svg>
          </span>
        </button>
        <button onclick="location.href='/calculator'" class="text-sm font-medium text-gray-600 dark:text-gray-300 hover:text-gray-900 dark:hover:text-white hover:bg-gray-100 dark:hover:bg-gray-700 px-3 py-2 rounded-lg transition">Amps Calculator</button>
        <button onclick="location.href='/settings'" class="text-sm font-medium text-gray-600 dark:text-gray-300 hover:text-gray-900 dark:hover:text-white hover:bg-gray-100 dark:hover:bg-gray-700 px-3 py-2 rounded-lg transition">Settings</button>
      </div>
    </div>
  </header>

  <!-- Main Content -->
  <main class="p-4 sm:p-6 lg:p-8 max-w-5xl mx-auto">
    <!-- User Section -->
    <div class="bg-white dark:bg-gray-800 rounded-xl p-5 shadow-sm mb-4 transition-colors">
      <h2 class="text-lg font-semibold text-gray-900 dark:text-white mb-2">User</h2>
      <select id="userSelect" onchange="saveSelectedUser()" class="block w-full max-w-xs rounded-lg border border-gray-300 dark:border-gray-600 py-2.5 pl-3 pr-10 text-gray-900 dark:text-white dark:bg-gray-700 focus:border-emerald-500 focus:ring-emerald-500 text-sm">
      </select>
      <p class="mt-2 text-sm text-gray-500 dark:text-gray-400">Selected user will be attached to new sessions.</p>
    </div>

    <!-- Controls Section -->
    <div class="bg-white dark:bg-gray-800 rounded-xl p-5 shadow-sm mb-4 transition-colors">
      <div class="flex gap-3" id="controlButtons">
        <!-- Buttons rendered by JS based on clock hours -->
      </div>
      <p class="mt-2 text-sm text-gray-500 dark:text-gray-400" id="clockModeNote"></p>
    </div>

    <!-- Amps Slider -->
    <div class="bg-white dark:bg-gray-800 rounded-xl p-5 shadow-sm mb-4 transition-colors">
      <div class="text-lg font-semibold text-gray-900 dark:text-white mb-3">Max Amps: <span id="ampsVal">N/A</span></div>
      <input id="amps" type="range" min="6" max="16" step="1" disabled
         class="w-full h-2 bg-gray-200 dark:bg-gray-600 rounded-lg appearance-none cursor-pointer disabled:opacity-50 disabled:cursor-not-allowed accent-emerald-500"
         oninput="ampsVal.innerText=this.value+'A'"
         onchange="setAmps()" />
    </div>

    <!-- Status and Telemetry Grid -->
    <div class="grid md:grid-cols-2 gap-4 mb-4">
      <!-- Status Card -->
      <div id="statusCard" class="bg-white dark:bg-gray-800 rounded-xl p-5 shadow-sm transition-colors relative overflow-hidden">
        <div id="chargingBarLeft" class="absolute inset-0 charging-bar-left opacity-0 pointer-events-none transition-opacity duration-500"></div>
        <div class="relative z-10">
          <div class="flex justify-between items-start mb-3">
            <h2 class="text-lg font-semibold text-gray-900 dark:text-white flex items-center gap-2 select-none" ondblclick="toggleDemoMode()">
              Status
              <span id="chargingBolt" class="hidden text-xl bolt-animate">‚ö°</span>
            </h2>
            <span id="availability" class="text-sm font-medium text-gray-600 dark:text-gray-400">...</span>
          </div>
          <p class="text-xs text-gray-500 dark:text-gray-400 italic mb-3" id="lastUpdate">Last update: -</p>
          <div id="statusText" class="space-y-1"></div>
        </div>
      </div>

      <!-- Telemetry Card -->
      <div id="telemetryCard" class="bg-white dark:bg-gray-800 rounded-xl p-5 shadow-sm transition-colors relative overflow-hidden">
        <div id="chargingBarRight" class="absolute inset-0 charging-bar-right opacity-0 pointer-events-none transition-opacity duration-500"></div>
        <div class="relative z-10">
          <h2 class="text-lg font-semibold text-gray-900 dark:text-white mb-3">Telemetry</h2>
          <div id="telemetry" class="space-y-1"></div>
        </div>
      </div>
    </div>

    <!-- History Section -->
    <div class="bg-white dark:bg-gray-800 rounded-xl p-5 shadow-sm transition-colors">
      <div class="flex justify-between items-center mb-4">
        <h2 class="text-lg font-semibold text-gray-900 dark:text-white">History</h2>
        <button onclick="location.href='/sessions'" class="text-sm text-emerald-600 dark:text-emerald-400 hover:text-emerald-700 dark:hover:text-emerald-300 font-medium">View All ‚Üí</button>
      </div>
      <div id="history" class="text-sm text-gray-500 dark:text-gray-400">No sessions yet.</div>
    </div>
  </main>

  <!-- Session Note Modal -->
  <div id="noteModal" class="hidden fixed inset-0 z-50 flex items-center justify-center bg-black bg-opacity-50">
    <div class="bg-white dark:bg-gray-800 rounded-xl p-6 w-full max-w-md mx-4 shadow-xl">
      <h3 class="text-lg font-semibold text-gray-900 dark:text-white mb-4">Add Note to Session</h3>
      <input type="hidden" id="noteSessionId" />
      <textarea id="noteText" rows="3" placeholder="e.g., Road trip prep, Weekly top-up..." 
        class="w-full rounded-lg border border-gray-300 dark:border-gray-600 py-2.5 px-3 text-gray-900 dark:text-white dark:bg-gray-700 focus:border-emerald-500 focus:ring-emerald-500 text-sm"></textarea>
      <div class="flex gap-3 mt-4">
        <button onclick="closeNoteModal()" class="flex-1 py-2 px-4 rounded-lg font-medium text-gray-700 dark:text-gray-300 bg-gray-100 dark:bg-gray-700 hover:bg-gray-200 dark:hover:bg-gray-600 transition">Cancel</button>
        <button onclick="saveNote()" class="flex-1 py-2 px-4 rounded-lg font-medium text-white bg-emerald-500 hover:bg-emerald-600 transition">Save</button>
      </div>
    </div>
  </div>

<script>
let isDragging = false;
let debounceTimer = null;

// optimistic lock
let pendingAmps = null;
let lockUntilTs = 0;

let clockSettings = { clock_start: '07:00', clock_end: '23:00' };
let isCharging = false;
let hasData = false;
let lastErrorDetails = null;
let errorDismissed = false;
let notificationsEnabled = false;
let demoMode = false;

// Demo mode toggle - triple-click on Status card header to toggle
function toggleDemoMode() {
  demoMode = !demoMode;
  updateChargingAnimation(demoMode);
  console.log('Demo mode:', demoMode ? 'ON ‚ö°' : 'OFF');
}

function updateChargingAnimation(charging) {
  const statusCard = document.getElementById('statusCard');
  const telemetryCard = document.getElementById('telemetryCard');
  const chargingBarLeft = document.getElementById('chargingBarLeft');
  const chargingBarRight = document.getElementById('chargingBarRight');
  const chargingBolt = document.getElementById('chargingBolt');
  
  if (charging) {
    statusCard.classList.add('charging-active');
    telemetryCard.classList.add('charging-active');
    chargingBarLeft.classList.remove('opacity-0');
    chargingBarLeft.classList.add('opacity-100');
    chargingBarRight.classList.remove('opacity-0');
    chargingBarRight.classList.add('opacity-100');
    chargingBolt.classList.remove('hidden');
  } else {
    statusCard.classList.remove('charging-active');
    telemetryCard.classList.remove('charging-active');
    chargingBarLeft.classList.add('opacity-0');
    chargingBarLeft.classList.remove('opacity-100');
    chargingBarRight.classList.add('opacity-0');
    chargingBarRight.classList.remove('opacity-100');
    chargingBolt.classList.add('hidden');
  }
}

// Dark mode - default is dark, only light if explicitly set to 'false'
function initDarkMode() {
  const isDark = localStorage.getItem('darkMode') !== 'false';
  if (isDark) document.documentElement.classList.add('dark');
  else document.documentElement.classList.remove('dark');
}

function toggleDarkMode() {
  const isDark = document.documentElement.classList.toggle('dark');
  localStorage.setItem('darkMode', isDark);
}

initDarkMode();

// Notifications
async function requestNotificationPermission() {
  if (!('Notification' in window)) return false;
  if (Notification.permission === 'granted') {
    notificationsEnabled = true;
    return true;
  }
  if (Notification.permission !== 'denied') {
    const permission = await Notification.requestPermission();
    notificationsEnabled = permission === 'granted';
    return notificationsEnabled;
  }
  return false;
}

function showNotification(title, body, icon = 'üîå') {
  if (!notificationsEnabled) return;
  try {
    new Notification(title, { body, icon: '/favicon.ico', badge: '/favicon.ico' });
  } catch(e) {
    // Fallback for mobile
    if ('serviceWorker' in navigator && navigator.serviceWorker.controller) {
      navigator.serviceWorker.controller.postMessage({ type: 'notification', title, body });
    }
  }
}

// Request permission on first interaction
document.body.addEventListener('click', () => {
  if (!notificationsEnabled) requestNotificationPermission();
}, { once: true });

// Error Alert
function showErrorAlert(message) {
  if (errorDismissed && message === lastErrorDetails) return;
  const alert = document.getElementById('errorAlert');
  document.getElementById('errorAlertText').innerText = message;
  alert.classList.remove('hidden');
  errorDismissed = false;
}

function hideErrorAlert() {
  document.getElementById('errorAlert').classList.add('hidden');
}

function dismissErrorAlert() {
  errorDismissed = true;
  hideErrorAlert();
}

function currentUser(){
  const sel = document.getElementById('userSelect');
  return sel ? sel.value : 'Unknown';
}

async function saveSelectedUser(){
  const user = currentUser();
  await fetch('/api/settings', {
    method: 'POST',
    headers: {'Content-Type': 'application/json'},
    body: JSON.stringify({selected_user: user})
  });
}

function showToast(message, type = 'warning', duration = 5000){
  const container = document.getElementById('toastContainer');
  const toast = document.createElement('div');
  toast.className = `toast toast-${type}`;
  toast.textContent = message;
  container.appendChild(toast);
  
  setTimeout(() => {
    toast.style.animation = 'fadeOut 0.3s ease forwards';
    setTimeout(() => toast.remove(), 300);
  }, duration);
}

// Command verification - check if state changed as expected
async function verifyCommand(expectedCharging, commandName, timeout = 10000){
  const startState = isCharging;
  await new Promise(r => setTimeout(r, timeout));
  await load(); // Refresh state
  
  if (isCharging === expectedCharging) {
    // Success - state changed as expected
    return true;
  }
  
  // State didn't change - show warning
  showToast(`‚ö†Ô∏è ${commandName} command may have failed - state unchanged`, 'warning');
  return false;
}

function isWithinClockHours(){
  const now = new Date();
  const jerusalemTime = new Date(now.toLocaleString('en-US', { timeZone: 'Asia/Jerusalem' }));
  const currentMinutes = jerusalemTime.getHours() * 60 + jerusalemTime.getMinutes();

  const [startH, startM] = clockSettings.clock_start.split(':').map(Number);
  const [endH, endM] = clockSettings.clock_end.split(':').map(Number);
  const startMinutes = startH * 60 + startM;
  const endMinutes = endH * 60 + endM;

  if (startMinutes <= endMinutes) {
    return currentMinutes >= startMinutes && currentMinutes < endMinutes;
  } else {
    return currentMinutes >= startMinutes || currentMinutes < endMinutes;
  }
}

function renderControlButtons(){
  const container = document.getElementById('controlButtons');
  const note = document.getElementById('clockModeNote');
  const withinClock = isWithinClockHours();

  if (!hasData) {
    container.innerHTML = `
      <button class="flex-1 py-3 px-4 rounded-xl font-bold text-white bg-gray-300 dark:bg-gray-600 cursor-not-allowed" disabled>Start</button>
      <button class="flex-1 py-3 px-4 rounded-xl font-bold text-white bg-gray-300 dark:bg-gray-600 cursor-not-allowed" disabled>Stop</button>
    `;
    note.innerHTML = '<svg class="inline w-4 h-4 mr-1 animate-spin" fill="none" viewBox="0 0 24 24"><circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"></circle><path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"></path></svg> Waiting for charger data...';
    return;
  }

  if (withinClock) {
    const label = isCharging ? 'Stop ‚èπÔ∏è' : 'Start ‚ñ∂Ô∏è';
    const bgClass = isCharging ? 'bg-red-500 hover:bg-red-600' : 'bg-emerald-500 hover:bg-emerald-600';
    // Clock mode: charger is a toggle, same command (start) for both start and stop
    container.innerHTML = `<button class="ripple flex-1 py-3 px-4 rounded-xl font-bold text-white transition cursor-pointer ${bgClass}" onclick="handleStartClick(this)">${label}</button>`;
    note.innerText = 'üïê Clock mode active ‚Äì toggle charging with one button';
  } else {
    container.innerHTML = `
      <button class="ripple flex-1 py-3 px-4 rounded-xl font-bold text-white bg-emerald-500 hover:bg-emerald-600 transition cursor-pointer" onclick="handleStartClick(this)">Start</button>
      <button class="ripple flex-1 py-3 px-4 rounded-xl font-bold text-white bg-red-500 hover:bg-red-600 transition cursor-pointer" onclick="handleControlClick(this, '/api/stop')">Stop</button>
    `;
    note.innerText = '';
  }
}

async function post(url){
  try{
    const r = await fetch(url, {method:'POST'});
    if(!r.ok) return false;
    return true;
  }catch(e){
    return false;
  }
}

// Button click handlers with loading animation and verification
async function handleControlClick(btn, url) {
  btn.classList.add('btn-loading');
  btn.disabled = true;
  const wasCharging = isCharging;
  await post(url);
  setTimeout(() => {
    btn.classList.remove('btn-loading');
    btn.disabled = false;
  }, 800);
  
  // Verify stop command executed (expect not charging)
  if (url.includes('/api/stop')) {
    verifyCommand(false, 'STOP');
  }
}

async function handleStartClick(btn) {
  btn.classList.add('btn-loading');
  btn.disabled = true;
  const wasCharging = isCharging;
  const user = encodeURIComponent(currentUser());
  await post('/api/start_for/' + user);
  setTimeout(() => {
    btn.classList.remove('btn-loading');
    btn.disabled = false;
  }, 800);
  
  // For toggle mode (clock), expect opposite state; otherwise expect charging
  const expectedState = isWithinClockHours() ? !wasCharging : true;
  verifyCommand(expectedState, wasCharging ? 'STOP' : 'START');
}

async function startWithUser(){
  const user = encodeURIComponent(currentUser());
  await post('/api/start_for/' + user);
}

async function setAmps(){
  const v = Number(document.getElementById('amps').value);
  pendingAmps = v;
  lockUntilTs = Date.now() + 4000;
  await post('/api/amps/' + v);
  setTimeout(load, 800);
}

function kv(k, v, highlight = false){
  const valueClass = highlight ? 'font-bold text-emerald-600 dark:text-emerald-400' : 'font-semibold text-gray-900 dark:text-white';
  return `<div class="flex justify-between text-sm">
    <span class="text-gray-600 dark:text-gray-400">${k}</span>
    <span class="${valueClass}">${v}</span>
  </div>`;
}

function fmtDate(isoStr){
  if (!isoStr) return '?';
  try {
    const d = new Date(isoStr);
    return d.toLocaleString('he-IL', {
      timeZone: 'Asia/Jerusalem',
      day: '2-digit',
      month: '2-digit',
      year: '2-digit',
      hour: '2-digit',
      minute: '2-digit'
    });
  } catch(e) {
    return isoStr;
  }
}

let pricePerKwh = 0;
let batteryCapacity = 64;
let clockDiscountPercent = 20;

function isMinuteInClock(minute) {
  const [startH, startM] = clockSettings.clock_start.split(':').map(Number);
  const [endH, endM] = clockSettings.clock_end.split(':').map(Number);
  const startMinutes = startH * 60 + startM;
  const endMinutes = endH * 60 + endM;

  if (startMinutes <= endMinutes) {
    return minute >= startMinutes && minute < endMinutes;
  } else {
    return minute >= startMinutes || minute < endMinutes;
  }
}

function calcClockMinutes(startedAt, endedAt) {
  const startDate = new Date(startedAt);
  const endDate = endedAt ? new Date(endedAt) : new Date();

  let clockMins = 0;
  let nonClockMins = 0;

  const current = new Date(startDate);
  while (current < endDate) {
    const jTime = new Date(current.toLocaleString('en-US', { timeZone: 'Asia/Jerusalem' }));
    const minuteOfDay = jTime.getHours() * 60 + jTime.getMinutes();

    if (isMinuteInClock(minuteOfDay)) {
      clockMins++;
    } else {
      nonClockMins++;
    }
    current.setMinutes(current.getMinutes() + 1);
  }

  return { clockMins, nonClockMins };
}

function calcSessionCost(energyVal, startedAt, endedAt) {
  if (energyVal <= 0) return 0;

  const { clockMins, nonClockMins } = calcClockMinutes(startedAt, endedAt);
  const totalMins = clockMins + nonClockMins;

  if (totalMins === 0) return energyVal * pricePerKwh;

  const clockEnergy = energyVal * (clockMins / totalMins);
  const nonClockEnergy = energyVal * (nonClockMins / totalMins);

  const discountMultiplier = 1 - (clockDiscountPercent / 100);
  const clockCost = clockEnergy * pricePerKwh * discountMultiplier;
  const nonClockCost = nonClockEnergy * pricePerKwh;

  return clockCost + nonClockCost;
}

function fmtSession(s){
  const start = fmtDate(s.started_at);
  const ongoing = !s.ended_at;
  const end = ongoing ? '‚ö° ongoing' : fmtDate(s.ended_at);

  let energyVal = 0;
  if (s.session_energy_kwh != null) {
    energyVal = s.session_energy_kwh;
  } else if (s.end_amount_kwh != null && s.start_amount_kwh != null) {
    energyVal = s.end_amount_kwh - s.start_amount_kwh;
  }
  const energy = energyVal.toFixed(1) + ' kWh';
  const batteryPct = batteryCapacity > 0 ? Math.round((energyVal / batteryCapacity) * 100) : 0;
  const cost = '‚Ç™' + calcSessionCost(energyVal, s.started_at, s.ended_at).toFixed(2);

  const user = (s.meta && s.meta.user) ? s.meta.user : 'Unknown';
  const note = (s.meta && s.meta.note) ? s.meta.note : '';

  return `<div class="py-2 border-b border-gray-100 dark:border-gray-700 last:border-0 flex items-center gap-3">
    <div class="flex-1">
      <div class="flex items-center gap-2 flex-wrap">
        <span class="font-bold text-gray-900 dark:text-white">${energy}</span>
        <span class="text-emerald-600 dark:text-emerald-400 font-medium">(+${batteryPct}%)</span>
        <span class="text-gray-500 dark:text-gray-500">¬∑</span>
        <span class="text-gray-600 dark:text-gray-400">${cost}</span>
        <span class="text-gray-500 dark:text-gray-500">¬∑</span>
        <span class="text-gray-600 dark:text-gray-400">${user}</span>
        ${ongoing ? '<span class="text-emerald-500">üîå</span>' : ''}
        ${note ? `<span class="text-gray-500 dark:text-gray-500">¬∑</span><span class="text-amber-600 dark:text-amber-400 italic text-sm">${note}</span>` : ''}
      </div>
      <div class="text-xs text-gray-400 dark:text-gray-500 mt-0.5">${start} ‚Üí ${end}</div>
    </div>
    <button onclick="openNoteModal('${s.id}')" class="text-gray-400 dark:text-gray-500 hover:text-emerald-500 dark:hover:text-emerald-400 px-2 transition" title="${note || 'Add note'}">
      <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M11 5H6a2 2 0 00-2 2v11a2 2 0 002 2h11a2 2 0 002-2v-5m-1.414-9.414a2 2 0 112.828 2.828L11.828 15H9v-2.828l8.586-8.586z"></path></svg>
    </button>
  </div>`;
}

// Note Modal
let sessionNotes = {};

function openNoteModal(sessionId) {
  document.getElementById('noteSessionId').value = sessionId;
  document.getElementById('noteText').value = sessionNotes[sessionId] || '';
  document.getElementById('noteModal').classList.remove('hidden');
  document.getElementById('noteText').focus();
}

function closeNoteModal() {
  document.getElementById('noteModal').classList.add('hidden');
}

async function saveNote() {
  const sessionId = document.getElementById('noteSessionId').value;
  const note = document.getElementById('noteText').value.trim();
  
  try {
    const r = await fetch('/api/session/' + sessionId + '/note', {
      method: 'POST',
      headers: {'Content-Type': 'application/json'},
      body: JSON.stringify({ note })
    });
    if (r.ok) {
      sessionNotes[sessionId] = note;
      closeNoteModal();
      loadSessions();
    }
  } catch(e) {}
}

async function loadSessions(){
  try{
    const r = await fetch('/api/sessions');
    if (!r.ok) return;
    const data = await r.json();
    const list = data.sessions || [];
    const el = document.getElementById('history');
    if (!list.length){
      el.innerText = 'No sessions yet.';
      return;
    }
    // Cache notes
    list.forEach(s => {
      if (s.meta && s.meta.note) sessionNotes[s.id] = s.meta.note;
    });
    const recent = list.slice(0, 10);
    el.innerHTML = recent.map(fmtSession).join('');
  }catch(e){}
}

let lastUpdateTs = 0;

function updateLastUpdateDisplay(){
  const el = document.getElementById('lastUpdate');
  if (!lastUpdateTs) {
    el.innerText = 'Last update: -';
    el.className = 'text-xs text-gray-500 dark:text-gray-400 italic mb-3';
    return;
  }
  const agoSec = Math.round((Date.now() / 1000) - lastUpdateTs);
  const stale = agoSec > 30;
  el.innerText = 'Last update: ' + agoSec + 's ago';
  el.className = stale ? 'text-xs italic mb-3 text-red-500' : 'text-xs italic mb-3 text-emerald-500';
}

setInterval(updateLastUpdateDisplay, 1000);

async function load(){
  if (isDragging) return;

  const r = await fetch('/api/state');
  const data = await r.json();

  lastUpdateTs = data.last_update || 0;
  updateLastUpdateDisplay();

  const availEl = document.getElementById('availability');
  if (data.availability === 'online') {
    availEl.innerHTML = 'Connected <span class="inline-block w-2 h-2 rounded-full bg-emerald-500 ml-1"></span>';
  } else {
    availEl.innerHTML = 'Disconnected <span class="inline-block w-2 h-2 rounded-full bg-red-500 ml-1"></span>';
  }

  const ch = data.charge || {};
  const cfg = data.config || {};

  const telemAmps = cfg.charge_amps;

  const lockActive = pendingAmps !== null && Date.now() < lockUntilTs;
  const telemMatchesPending = pendingAmps !== null && telemAmps === pendingAmps;

  if (!lockActive || telemMatchesPending){
    if (telemMatchesPending) pendingAmps = null;
    document.getElementById('amps').value = telemAmps ?? 16;
    document.getElementById('ampsVal').innerText = telemAmps != null ? telemAmps + 'A' : 'N/A';
  } else {
    document.getElementById('amps').value = pendingAmps;
    document.getElementById('ampsVal').innerText = pendingAmps + 'A';
  }

  const wasCharging = isCharging;
  const hadData = hasData;
  isCharging = (ch.output_state === 'Charging');
  hasData = Object.keys(ch).length > 0;

  // Charging complete notification
  if (wasCharging && !isCharging && hadData) {
    showNotification('Charging Complete! ‚ö°', 'Your car has finished charging.');
  }

  if (wasCharging !== isCharging || hadData !== hasData) {
    renderControlButtons();
    const ampsSlider = document.getElementById('amps');
    ampsSlider.disabled = !hasData;
  }

  // Update charging animation (unless demo mode is active)
  if (!demoMode) {
    updateChargingAnimation(isCharging);
  }

  // Error detection
  const errorDetails = ch.error_details;
  const isNoError = !errorDetails || errorDetails === '-' || 
    errorDetails.toLowerCase().includes('no error');
  
  if (!isNoError && errorDetails !== lastErrorDetails) {
    showErrorAlert('‚ö†Ô∏è ' + errorDetails);
    showNotification('Charger Error! ‚ö†Ô∏è', errorDetails);
    lastErrorDetails = errorDetails;
  } else if (isNoError) {
    hideErrorAlert();
    lastErrorDetails = null;
    errorDismissed = false;
  }

  const statusHtml = [];
  statusHtml.push(kv("Plug", ch.plug_state ?? '-'));
  statusHtml.push(kv("State", ch.output_state ?? '-', ch.output_state === 'Charging'));
  statusHtml.push(kv("Errors", ch.error_details ?? '-'));
  document.getElementById('statusText').innerHTML = statusHtml.join('');

  function fmtPhase(v, a) {
    if (v == null && a == null) return '-';
    const vStr = v != null ? Math.round(v) + 'V' : '-';
    const aStr = a != null ? a.toFixed(1) + 'A' : '-';
    return vStr + ' ' + aStr;
  }

  function rssiToWord(rssi) {
    if (rssi == null) return '-';
    if (rssi >= -50) return 'Excellent';
    if (rssi >= -70) return 'Good';
    if (rssi >= -80) return 'Fair';
    if (rssi >= -90) return 'Weak';
    return 'Very Weak';
  }

  const t = [];
  t.push(kv("L1", fmtPhase(ch.l1_voltage, ch.l1_amperage)));
  t.push(kv("L2", fmtPhase(ch.l2_voltage, ch.l2_amperage)));
  t.push(kv("L3", fmtPhase(ch.l3_voltage, ch.l3_amperage)));
  t.push(kv("Charging Rate", ch.total_energy != null ? ch.total_energy + ' kW' : '-'));
  t.push(kv("Acc kWh", ch.current_amount != null ? ch.current_amount.toFixed(1) + ' kWh' : '-'));
  t.push(kv("Temperature", ch.inner_temp_c != null ? ch.inner_temp_c + '¬∞C' : '-'));
  t.push(kv("Signal Strength", rssiToWord(cfg.rssi)));
  document.getElementById('telemetry').innerHTML = t.join('');
}

const ampsEl = document.getElementById('amps');

ampsEl.addEventListener('touchstart', () => { isDragging = true; });
ampsEl.addEventListener('mousedown',  () => { isDragging = true; });

function dragEnd(){
  isDragging = false;
  clearTimeout(debounceTimer);
  debounceTimer = setTimeout(setAmps, 400);
}

ampsEl.addEventListener('touchend', dragEnd);
ampsEl.addEventListener('mouseup',  dragEnd);

ampsEl.addEventListener('input', (e) => {
  document.getElementById('ampsVal').innerText = e.target.value + 'A';
  clearTimeout(debounceTimer);
  debounceTimer = setTimeout(setAmps, 600);
});

async function loadSettings(){
  try {
    const r = await fetch('/api/settings');
    if (!r.ok) return;
    const settings = await r.json();

    clockSettings.clock_start = settings.clock_start || '07:00';
    clockSettings.clock_end = settings.clock_end || '23:00';

    pricePerKwh = settings.price_per_kwh;
    clockDiscountPercent = settings.clock_discount_percent ?? 20;
    batteryCapacity = settings.battery_capacity_kwh || 64;

    const users = settings.users || ['Lidor', 'Bar'];
    const sel = document.getElementById('userSelect');
    sel.innerHTML = users.map(u => `<option value="${u}">${u}</option>`).join('');
    
    // Restore selected user from settings
    if (settings.selected_user && users.includes(settings.selected_user)) {
      sel.value = settings.selected_user;
    }

    renderControlButtons();
  } catch(e) {}
}

loadSettings().then(() => {
  load();
  loadSessions();
  renderControlButtons();
});
setInterval(load, 2000);
setInterval(loadSessions, 15000);
setInterval(renderControlButtons, 60000);
</script>

</body>
</html>
