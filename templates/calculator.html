<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Charging Calculator - MG4 Charger</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <style>
    body {
      font-family: 'Inter', system-ui, -apple-system, sans-serif;
    }
  </style>
</head>
<body class="bg-gray-50 min-h-screen">
  <!-- Header -->
  <header class="bg-white shadow-sm sticky top-0 z-10">
    <div class="max-w-5xl mx-auto px-4 sm:px-6 lg:px-8 flex justify-between items-center h-16">
      <h1 class="text-xl font-semibold text-gray-900">üîå Charging Calculator</h1>
      <button onclick="location.href='/'" class="text-sm font-medium text-gray-600 hover:text-gray-900 hover:bg-gray-100 px-3 py-2 rounded-lg transition">‚Üê Back</button>
    </div>
  </header>

  <!-- Main Content -->
  <main class="p-4 sm:p-6 lg:p-8 max-w-5xl mx-auto">
    <div class="grid md:grid-cols-2 gap-4">
      <!-- Input Column -->
      <div class="space-y-4">
        <!-- Current Battery -->
        <div class="bg-white rounded-xl p-5 shadow-sm">
          <label class="block text-sm font-medium text-gray-600 mb-2">Current Battery %</label>
          <input type="number" id="currentPercent" min="0" max="100" value="20" inputmode="numeric" 
            class="w-full rounded-lg border border-gray-300 py-3 px-4 text-lg text-gray-900 focus:border-emerald-500 focus:ring-emerald-500" />
        </div>

        <!-- Target Battery -->
        <div class="bg-white rounded-xl p-5 shadow-sm">
          <label class="block text-sm font-medium text-gray-600 mb-2">Target Battery %</label>
          <input type="number" id="targetPercent" min="0" max="100" value="80" inputmode="numeric"
            class="w-full rounded-lg border border-gray-300 py-3 px-4 text-lg text-gray-900 focus:border-emerald-500 focus:ring-emerald-500" />
        </div>

        <!-- Time Available -->
        <div class="bg-white rounded-xl p-5 shadow-sm">
          <label class="block text-sm font-medium text-gray-600 mb-2">Time Available (hours)</label>
          <input type="number" id="availableHours" min="0" step="0.5" value="8" inputmode="decimal"
            class="w-full rounded-lg border border-gray-300 py-3 px-4 text-lg text-gray-900 focus:border-emerald-500 focus:ring-emerald-500" />
        </div>

        <!-- Balancing Time -->
        <div class="bg-white rounded-xl p-5 shadow-sm">
          <label class="block text-sm font-medium text-gray-600 mb-2">Balancing Time (minutes)</label>
          <input type="number" id="balancingMinutes" min="0" value="0" inputmode="numeric"
            class="w-full rounded-lg border border-gray-300 py-3 px-4 text-lg text-gray-900 focus:border-emerald-500 focus:ring-emerald-500" />
          <p class="text-xs text-gray-500 mt-2">Extra time when charging slows near full to equalize cell voltages</p>
        </div>
      </div>

      <!-- Result Column -->
      <div class="space-y-4">
        <!-- Result Card -->
        <div class="bg-white rounded-xl p-6 shadow-sm" id="resultCard">
          <div class="text-center">
            <div class="text-5xl font-bold text-emerald-600" id="resultValue">-</div>
            <div class="text-sm text-gray-500 mt-2" id="resultLabel">Recommended Amps</div>
            <button id="setAmpsBtn" onclick="setAmps()" style="display:none;"
              class="mt-4 w-full py-3 px-4 rounded-xl font-bold text-white bg-emerald-500 hover:bg-emerald-600 transition cursor-pointer">
              Set Amps
            </button>
          </div>
        </div>

        <!-- Details Card -->
        <div class="bg-white rounded-xl p-5 shadow-sm" id="detailsCard" style="display:none;">
          <h3 class="text-lg font-semibold text-gray-900 mb-4">üìä Details</h3>
          <div class="space-y-3">
            <div class="flex justify-between text-sm">
              <span class="text-gray-600">Battery Capacity</span>
              <span class="font-semibold text-gray-900" id="detailCapacity">-</span>
            </div>
            <div class="flex justify-between text-sm">
              <span class="text-gray-600">Energy Needed</span>
              <span class="font-semibold text-gray-900" id="detailEnergy">-</span>
            </div>
            <div class="flex justify-between text-sm">
              <span class="text-gray-600">Actual Charging Time</span>
              <span class="font-semibold text-gray-900" id="detailTime">-</span>
            </div>
            <div class="flex justify-between text-sm">
              <span class="text-gray-600">Charging Rate</span>
              <span class="font-semibold text-gray-900" id="detailPower">-</span>
            </div>
          </div>
        </div>
      </div>
    </div>
  </main>

<script>
let batteryCapacity = 64;
let calculatedAmps = 0;

async function loadSettings() {
  try {
    const r = await fetch('/api/settings');
    if (!r.ok) return;
    const s = await r.json();
    batteryCapacity = s.battery_capacity_kwh || 64;
  } catch(e) {}
}

function calculate() {
  const currentPercent = parseFloat(document.getElementById('currentPercent').value) || 0;
  const targetPercent = parseFloat(document.getElementById('targetPercent').value) || 80;
  const availableHours = parseFloat(document.getElementById('availableHours').value) || 0;
  const balancingMinutes = parseFloat(document.getElementById('balancingMinutes').value) || 0;

  const resultCard = document.getElementById('resultCard');
  const resultValue = document.getElementById('resultValue');
  const resultLabel = document.getElementById('resultLabel');
  const detailsCard = document.getElementById('detailsCard');
  const setAmpsBtn = document.getElementById('setAmpsBtn');

  // Validation
  if (targetPercent <= currentPercent) {
    resultCard.className = 'bg-red-50 rounded-xl p-6 shadow-sm';
    resultValue.className = 'text-5xl font-bold text-red-500';
    resultValue.innerText = '‚ö†Ô∏è';
    resultLabel.innerText = 'Target must be higher than current %';
    detailsCard.style.display = 'none';
    setAmpsBtn.style.display = 'none';
    return;
  }

  // Calculate
  const percentNeeded = targetPercent - currentPercent;
  const energyNeeded = (percentNeeded / 100) * batteryCapacity;
  const safeAvailableHours = availableHours * 0.9;
  const actualChargingHours = safeAvailableHours - (balancingMinutes / 60);

  if (actualChargingHours <= 0) {
    resultCard.className = 'bg-red-50 rounded-xl p-6 shadow-sm';
    resultValue.className = 'text-5xl font-bold text-red-500';
    resultValue.innerText = '‚ö†Ô∏è';
    resultLabel.innerText = 'Not enough time after balancing';
    detailsCard.style.display = 'none';
    setAmpsBtn.style.display = 'none';
    return;
  }

  const requiredPowerKw = energyNeeded / actualChargingHours;
  const requiredAmps = (energyNeeded * 16) / (10 * actualChargingHours);

  // Show result
  resultCard.className = 'bg-white rounded-xl p-6 shadow-sm';
  resultValue.className = 'text-5xl font-bold text-emerald-600';
  
  if (requiredAmps > 16) {
    resultCard.className = 'bg-amber-50 rounded-xl p-6 shadow-sm';
    resultValue.className = 'text-5xl font-bold text-amber-600';
    resultValue.innerText = requiredAmps.toFixed(1) + ' A';
    resultLabel.innerText = '‚ö†Ô∏è Exceeds max 16A - need more time!';
    calculatedAmps = 16;
    setAmpsBtn.style.display = 'block';
    setAmpsBtn.innerText = 'Set Max (16 A)';
  } else if (requiredAmps < 6) {
    calculatedAmps = 6;
    resultValue.innerText = '6 A';
    resultLabel.innerText = 'Minimum 6A (will finish early)';
    setAmpsBtn.style.display = 'block';
    setAmpsBtn.innerText = 'Set 6 A';
  } else {
    calculatedAmps = Math.ceil(requiredAmps);
    resultValue.innerText = calculatedAmps + ' A';
    resultLabel.innerText = 'Recommended Setting';
    setAmpsBtn.style.display = 'block';
    setAmpsBtn.innerText = 'Set ' + calculatedAmps + ' A';
  }

  // Show details
  detailsCard.style.display = 'block';
  document.getElementById('detailCapacity').innerText = batteryCapacity + ' kWh';
  document.getElementById('detailEnergy').innerText = energyNeeded.toFixed(1) + ' kWh';
  document.getElementById('detailTime').innerText = actualChargingHours.toFixed(1) + ' hours (incl. 10% buffer)';
  document.getElementById('detailPower').innerText = requiredPowerKw.toFixed(2) + ' kW';
}

async function setAmps() {
  if (calculatedAmps < 6 || calculatedAmps > 16) return;
  
  const btn = document.getElementById('setAmpsBtn');
  btn.disabled = true;
  btn.innerText = 'Setting...';
  btn.className = 'mt-4 w-full py-3 px-4 rounded-xl font-bold text-white bg-gray-400 cursor-not-allowed';
  
  try {
    const r = await fetch('/api/amps/' + calculatedAmps, { method: 'POST' });
    if (r.ok) {
      btn.innerText = '‚úì Set to ' + calculatedAmps + ' A';
      btn.className = 'mt-4 w-full py-3 px-4 rounded-xl font-bold text-white bg-emerald-500';
      setTimeout(() => {
        window.location.href = '/';
      }, 500);
    } else {
      btn.innerText = '‚úó Failed';
      btn.disabled = false;
      btn.className = 'mt-4 w-full py-3 px-4 rounded-xl font-bold text-white bg-red-500 hover:bg-red-600 transition cursor-pointer';
    }
  } catch(e) {
    btn.innerText = '‚úó Error';
    btn.disabled = false;
    btn.className = 'mt-4 w-full py-3 px-4 rounded-xl font-bold text-white bg-red-500 hover:bg-red-600 transition cursor-pointer';
  }
}

// Auto-calculate on input change
document.querySelectorAll('input').forEach(input => {
  input.addEventListener('input', calculate);
});

loadSettings().then(() => calculate());
</script>

</body>
</html>
